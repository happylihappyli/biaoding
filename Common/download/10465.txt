using Common_Robot2;
using ConverxHull;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System.Threading;
using System.Net.Sockets;
using System.Net;

namespace Test1
{
    public class W_TCP_Server_Send : C_Node_Send
    {

        public string key_control = "";
        public string msg = "";
        public string encode = "GBK";
        public string base64 = "";//iAEABwAE
        public string tcp_server = "";
        public string hex = ""; //hex = "88,01,00,07,00,04";


        public W_TCP_Server_Send(string name, C_Space space_parent, C_Space space) :
            base(name,space_parent, space)
        {
        }



        public static byte[] hext_to_byte(string hex)
        {
            byte[] b = new byte[hex.Length / 2];
            for (var i = 0; i < hex.Length; i += 2)
            {
                string a = hex.Substring(i, 2);
                b[i / 2] = Convert.ToByte(a, 16);
            }
            return b;
        }



        public override Task run_sub()
        {
            run_sub_main();
            return Task.CompletedTask;
        }


        public void run_sub_main()
        {
            if (tcp_server != "")
            {
                key_control = (string)this.read_var("#" + tcp_server, "string");
            }

            I_TCP pServer = (I_TCP)space.vars_step[key_control];

            if (hex != "")
            {
                string hex2 = this.read_string(hex);
                hex2 = hex2.Replace(",", "");
                hex2 = hex2.Replace(" ", "");
                if (hex2 == "")
                {
                    Main.WriteLine(this,"hex2=None");
                    return;
                }
                byte[] gbk = hext_to_byte(hex2);

                Main.WriteLine(this,hex);
                pServer.Send(this, gbk);

            }
            else if (base64 != "")
            {
                byte[] gbk = Tools.Base64Decode(base64);
                pServer.Send(this, gbk);
            }
            else
            {
                string msg =this.read_string(this.msg);
                if (msg == "" || msg == null)
                {
                    Main.WriteLine(this,"msg=none");
                    S_TTS.speak_async("发送消息为空");
                    this.Next_Step = Node_Next.False;
                    return;
                }
                byte[] gbk = Encoding.GetEncoding(encode).GetBytes(msg);
                pServer.Send(this,gbk);
                Main.WriteLine(this,"msg:" + msg);
            }
            this.Next_Step = Node_Next.True;
        }


    }


}
