using Common_Robot2;
using Downloader;
using System.ComponentModel;
using System.Net;

namespace Test1
{
    public class W_Download_Service : C_Node
    {
        public string proxy_ip = "";//代理地址
        public string proxy_port= "";//代理端口


        public delegate void Event_Progress(string status);
        
        // 基于上面的委托定义事件
        public event Event_Progress pEvent;



        public DownloadService downloader = null;
        public W_Download_Service(string Name, C_Space space_parent, C_Space space) :
            base(space_parent, space)
        {
            this.Name = Name;
            space.vars_step.Add(Name, this);
        }

        public override Task run_sub()
        {
            run_sub_main();
            return Task.CompletedTask;
        }

        public void run_sub_main()
        {
            string str_proxy_ip = this.read_string(this.proxy_ip);
            string str_proxy_port = this.read_string(this.proxy_port);
            WebProxy proxy = null;

            if (str_proxy_ip != "")
            {
                proxy= new WebProxy
                {
                    Address = new Uri("socks5://" + str_proxy_ip + ":" + str_proxy_port)
                };
            }


            var downloadOpt = new DownloadConfiguration()
            {
                BufferBlockSize = 10240,// usually, hosts support max to 8000 bytes, default values is 8000
                ChunkCount = 8,// file parts to download, default value is 1
                MaximumBytesPerSecond = 1024 * 1024 * 2,// download speed limited to 2MB/s, default values is zero or unlimited
                MaxTryAgainOnFailover = 5, //错误重试次数
                MaximumMemoryBufferBytes = 1024 * 1024 * 50,// release memory buffer after each 50 MB
                ParallelDownload = true,// 是否同时下载文件的部分
                ParallelCount = 4,//同时下载的个数
                Timeout = 1000,// timeout (millisecond) per stream block reader, default values is 1000
                RangeDownload = false,// set true if you want to download just a specific range of bytes of a large file
                RangeLow = 0,//  部分下载文件的下限
                RangeHigh = 0,// 部分下载文件的上限
                ClearPackageOnCompletionWithFailure = true,// clear package chunks data when download completed with failure, default value is false
                // minimum size of chunking to download a file in multiple parts, default value is 512
                MinimumSizeOfChunking = 1024,
                // Before starting the download, reserve the storage space of the file as file size, default value is false
                ReserveStorageSpaceBeforeStartingDownload = true,

                // 自定义文件头
                RequestConfiguration =
                {
                    Accept = "*/*",
                    //CookieContainer = cookies,
                    Headers = new WebHeaderCollection(), // { your custom headers }
                    KeepAlive = true, // default value is false
                    ProtocolVersion = HttpVersion.Version11, // default value is HTTP 1.1
                    UseDefaultCredentials = false, // your custom user agent or your_app_name/app_version.
                    Proxy=proxy,
                    UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
                }
            };

            downloader = new DownloadService(downloadOpt);
            downloader.DownloadProgressChanged += OnDownloadProgressChanged;
        }

        private void OnDownloadProgressChanged(object? sender, Downloader.DownloadProgressChangedEventArgs e)
        {
            if (pEvent != null)
            {
                pEvent(e.ProgressPercentage+"");
            }
        }

        public void init()
        {
        }
    }
}
