
using Common_Robot2;
using ConverxHull;

namespace Test1
{
    public class D_Draw_Planets : C_Node
    {
        public string pic_read = "";
        public string pic_save = "";

        public string key_planets = "";
        public string key_camera = "";
        public string scale="2";

        public D_Draw_Planets(string name, C_Space space_parent, C_Space space) :
            base(name,space_parent, space)
        {
        }

        public override Task run_sub()
        {
            run_sub_main();
            return Task.CompletedTask;
        }

        public void run_sub_main()
        {

            if (pTrain == null) return;

            if (space.contains(pTrain, this, pic_read, "Bitmap") == false)
            {
                Console.Write(pic_read + " 读取图片为空！");
                S_TTS.speak_async(pic_read + " 读取图片为空！");
                return;
            }
            Bitmap pBitmapRGB = (Bitmap)this.read_var(pic_read, "Bitmap");//.pObj;

            float f_scale = float.Parse(this.scale);

            if (pBitmapRGB != null)
            {
                lock (pBitmapRGB)
                {
                    int width = pBitmapRGB.Width;
                    int height = pBitmapRGB.Height;
                    Bitmap a = new Bitmap(width, height);
                    Graphics g = Graphics.FromImage(a);

                    g.DrawImage(pBitmapRGB,
                        new Rectangle((int)space.vars.draw_offset_x_tuyang,
                                (int)space.vars.draw_offset_y_tuyang,
                        pBitmapRGB.Width - (int)space.vars.draw_offset_x_tuyang, pBitmapRGB.Height - (int)space.vars.draw_offset_y_tuyang),
                        new Rectangle(0, 0, pBitmapRGB.Width, pBitmapRGB.Height),
                        GraphicsUnit.Pixel);

                    List<C_Planet_Catch> pPlanets= (List<C_Planet_Catch>)this.read_var(key_planets, "C_Planet_Catch");

                    if (pPlanets == null)
                    {
                        Main.WriteLine(this, "平面为空：" + key_planets);
                    }
                    else
                    {
                        if (pPlanets.Count == 0)
                        {
                            Main.WriteLine(this, "平面为空：" + key_planets);
                        }
                        else
                        {
                            C_Camera_TuYang camera1 = (C_Camera_TuYang)this.read_var(key_camera, "C_Camera_TuYang");


                            float r = 20;
                            for (var i = 0; i < pPlanets.Count; i++)
                            {
                                C_Planet_Catch pPlanet = pPlanets[i];
                                C_Point3D center = Tools.机械臂坐标到摄像头坐标(camera1, pPlanet.arm_a.subtract(new C_Point3D(pPlanet.dx,pPlanet.dy,pPlanet.dz)));
                                C_Point3D center2 = Tools.f_3DPoint_to_depth(camera1.camera1.color_calib, center);
                                center2.x = center2.x / f_scale;
                                center2.y = center2.y / f_scale;

                                g.FillEllipse(Brushes.Red, center2.x - r, center2.y - r, 2*r, 2*r);
                            }
                        }
                    }


                    this.save_var(pic_save, "Bitmap", a);
                }
            }

        }


        public override void init()
        {
            
        }
    }
}
