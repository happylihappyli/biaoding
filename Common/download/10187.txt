using Common_Robot;
using Common_Robot2;
using ConverxHull;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace Test1
{
    public class C_Cloud_Save : C_Node
    {
        public string file = "";
        public string key_read = "cloud1";
        public string key_save = "file_name";
        //public string key_time_id = "";

        public C_Cloud_Save(string name, C_Space space_parent, C_Space space) :
            base(name, space_parent, space)
        {
        }

        public override Task run_sub()
        {
            run_sub_main();
            return Task.CompletedTask;

        }

        private void run_sub_main()
        {

            string file2 = space.tools.var_read(pTrain, this, this.file);

            string time_id = pTrain.get_Time_ID();// (string)this.read_var(this.key_time_id, "string");

            if (time_id == "")
            {
                time_id = DateTime.Now.ToString("yyyy_MM_dd__HH_mm_ss__FFF");
            }
            file2 = file2.Replace("@", time_id);

            this.save_var(this.key_save, "string", file2);

            save_file(file2);
        }

        public void save_file(string file2)
        {
            List<C_Point3D> pList = (List<C_Point3D>)this.read_var(this.key_read, "List<C_Point3D>");

            if (pList == null)
            {
                Main.show_tip(this, " 点云为空！", this.Name + " 点云为空！");
                S_TTS.speak_async(this.Name + " 点云为空！");
                return;
            }

            try
            {
                lock (pList)
                {
                    Main.save_cloud(file2, pList);
                }
            }
            catch (Exception e)
            {
                Main.WriteLine(e.ToString());
            }
        }

        public override void init()
        {
            
        }
    }
}
