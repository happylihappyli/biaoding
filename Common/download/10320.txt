using Common_Robot2;
using ConverxHull;
using Newtonsoft.Json.Linq;
using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace Test1
{
    public class S_Read_Bottom : C_Node
    {
        public string file = @"D:\data2\bottom.txt";
        public string file_matrix = @"D:\data2\camera_to_bottom.txt";
        public string key_save = "#pPlanet_Bottom";
        public string key_save_matrix = "#pPlanet_Bottom";
        public string min="10";
        public string key_camera="";

        public S_Read_Bottom(string name, C_Space space_parent, C_Space space):
            base(name, space_parent, space)
        {
        }


        public override Task run_sub()
        {

            run_sub_main();
            return Task.CompletedTask;
        }

        private void run_sub_main()
        {
            C_Planet Bottom = 读取底面信息();
            space.save_vars(null, this, key_save, "C_Planet", Bottom);
        }

        public C_Planet 读取底面信息()
        {
            C_Camera_TuYang camera1 = (C_Camera_TuYang)space.read_vars(pTrain, this, this.key_camera, "C_Camera_TuYang");


            if (camera1 == null)
            {
                Main.WriteLine(this,this.Name + "key_camera 设置有问题！");
                MessageBox.Show(this.Name + " key_camera 设置有问题！");
                return null;
            }


            //过滤底部信息需要先读取底部的标定信息
            string file_vector = this.file;
            if (File.Exists(file_vector) == false)
            {
                Main.WriteLine(this, " 底面信息文件为空   file 设置有问题！");
                Main.WriteLine(this," 底面信息文件"+ file_vector + "为空  file 设置有问题！");
                S_TTS.speak_async("底面信息文件不存在" +file_vector);
                return null;
            }
            FileStream fs_debug = new FileStream(file_vector, FileMode.Open, FileAccess.Read);

            List<C_Point3D> pListBottom = new List<C_Point3D>();
            StreamReader sr = new StreamReader(fs_debug, Encoding.UTF8);
            string line = sr.ReadLine();
            int iCount = 0;
            while (line != null)
            {
                if (line.StartsWith("camera="))
                {
                    line = line.Substring(7);
                }
                string[] strSplit = line.Split(',');
                if (strSplit.Length > 2)
                {
                    double x = double.Parse(strSplit[0]);
                    double y = double.Parse(strSplit[1]);
                    double z = double.Parse(strSplit[2]);
                    C_Point3D pPoint = new C_Point3D(x, y, z);
                    pListBottom.Add(pPoint);
                    iCount++;
                }
                line = sr.ReadLine();
            }
            sr.Close();
            fs_debug.Close();


            C_Point3D fa = Tools.平面拟合计算法向量等(pListBottom, false);

            C_Planet pPlanet = new C_Planet(-1);
            pPlanet.z_faxiangliang = fa;
            pPlanet.center = Tools.计算中心点坐标(pListBottom);

            C_Point3D arm_center= Tools.摄像头坐标转到机械臂坐标(camera1, pPlanet.center);

            StringBuilder Line = new StringBuilder();
            for (var i=0; i<30; i++)
            {
                C_Point3D arm_center_x1 = arm_center.add(new C_Point3D(10*i, 0, 0));
                C_Point3D arm_center_y1 = arm_center.add(new C_Point3D(0, 10*i, 0));

                C_Point3D camear_x1 = Tools.机械臂坐标到摄像头坐标(camera1, arm_center_x1);
                C_Point3D camear_y1 = Tools.机械臂坐标到摄像头坐标(camera1, arm_center_y1);

                C_Point3D camera_bottom_x1 = pPlanet.投影到一个面后的坐标(camear_x1);
                C_Point3D camera_bottom_y1 = pPlanet.投影到一个面后的坐标(camear_y1);

                Line.Append(camera_bottom_x1.ToString() + "," + camera_bottom_x1.distance(pPlanet.center)+",0,0\r\n");
                Line.Append(camera_bottom_y1.ToString() + ",0," + camera_bottom_y1.distance(pPlanet.center) + ",0\r\n");
            }
            File.WriteAllText(this.file_matrix, Line.ToString());
            C_Matrix matrix=Tools.计算变换矩阵(this.file_matrix);
            this.save_var(this.key_save_matrix, "C_Matrix", matrix);

            //https://www.geogebra.org/3d/wjjfehpk

            if (iCount < int.Parse(this.min))
            {
                MessageBox.Show("底面标定，采集的点个数太少，至少"+ int.Parse(this.min) + "个");
                return null;
            }
            return pPlanet;
        }

        public override void init()
        {
        }
    }
}
