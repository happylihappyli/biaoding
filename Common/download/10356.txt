using Common_Robot;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

using pcammls;
using System.Runtime.InteropServices;
using System.Drawing.Imaging;
using MvCamCtrl.NET;
using Common_Robot2;
using ConverxHull;

namespace Test1
{

    /// <summary>
    /// 拍照步骤，按模块化思路来做
    /// </summary>
    public class S_Camera_HK : C_Node
    {

        public C_Camera_hk camera_hk = new C_Camera_hk();
        public string index = "0";

        public IntPtr dev_handle;
        public C_Camera_Const camera_const = null;
        public static bool bInit = false;
        public static int nCount_TuYang = 0;

        public string control_2d = "";
        public string control_3d = "";
        public string key_save = "2d_pic";
        public string key_camera = "";//C_Camera_Const
        public string key_rgb = "";

        public C_DrawBox box1 = new C_DrawBox();//摄像头的机械臂抓取区域

        public int camera_w = 1280;
        public int camera_h = 960;
        public Bitmap pBitmap_Depth;
        public List<C_Point3D> pList_Point3D_Color = new List<C_Point3D>();


        public Task pLoop_Camera = null;
        public bool bCatching;

        public string camera_format = "";


        public string wait = "0";
        public string camera_id = "";//照相机ID
        public TimeSpan old;

        public int img_index = 0;
        public IntPtr handle;
        public TY_FRAME_DATA frame = null;
        public IntPtr color_isp_handle;

        public C_Point3D old_uv = null;//上一次位置

        public TY_VECT_3F_ARRAY glb_p3dArray = null;

        public TY_VECT_3F_ARRAY p3dArray;


        public int Pic_Count = -1;
        public bool Camera_Receive_Read = false;
        public int Pic_Index = 1;
        public ArrayList RGB_Array = new ArrayList();
        public ArrayList Depth_Array = new ArrayList();


        public bool recvFlag = false;
        public uint8_t_ARRAY[] buffer = new uint8_t_ARRAY[4];
        //public C_Cloud_Get 读取3D点云模块;
        public S_RGB_Get_HK 读取2D图片模块;

        public uint8_t_ARRAY undistort_color_data;//畸变矫正后的彩色图
        public uint16_t_ARRAY registration_depth_data;//对齐到彩色图坐标系的深度图
        public uint8_t_ARRAY color_data;//彩色原图
        public uint8_t_ARRAY color_data2;//彩色原图2
        public int color_width;
        public int color_height;

        public TY_IMAGE_DATA src = new TY_IMAGE_DATA();
        public TY_IMAGE_DATA dst = new TY_IMAGE_DATA();

        public C_Point3D[,] Image_Point_3D = null;
        private bool depth_2_rgb = true;
        private uint16_t_ARRAY depth_result;
        public Data_RGB pLast = null;
        public string key_3d = "#3F_ARRAY";
        public string key_camera_time = "";
        public string save_color_cloud = "0";
        public string key_compare = "";
        public string depth_camera="0";

        public S_Camera_HK(string name, C_Space space_parent, C_Space space) : base(space_parent, space)
        {
            this.Name = name;
            space.vars_step.Add(Name, this);
        }

        public void init()
        {
            this.读取2D图片模块 = (S_RGB_Get_HK)space.vars_step[this.control_2d];
            camera_hk.call_get_picture += new C_Camera_hk.Get_Picture(callback_get_picture);


            //if (S_Camera.bInit == false)
            {
                bInit = true;
                //初始化
                //SDK.TYInitLib();
                //获取相机lib版本
                TY_VERSION_INFO info = new TY_VERSION_INFO();
                //SDK.TYLibVersion(info);
                space.console.WriteLine(string.Format("版本 :{0} {1} {2}", info.major, info.minor, info.patch), Level_Enum.Info, log_index, Name);
            }
        }

            public void Start()
        {
            camera_hk.DeviceListAcq();
            camera_hk.open_device(int.Parse(this.index));
            camera_hk.open_trigger();
            camera_hk.start();
        }


        public void callback_get_picture(Bitmap image)
        {
            //this.读取2D图片模块.pLast2 = pData_RGB;
            //this.读取2D图片模块.pixel_arr = pData_RGB.pixel_arr;
            this.读取2D图片模块.img = image;// pData_RGB.img;
            //this.读取2D图片模块.color_data = color_data;
            this.读取2D图片模块.pCamera = this;
            this.读取2D图片模块.pTrain = this.pTrain;
            //pData_RGB.pixel_arr = null;
            //pData_RGB.img = null;

            if (depth_2_rgb)
            {
                this.读取2D图片模块.Run(pTrain);
            }
        }


        public void set_2d(S_RGB_Get_HK 读取2D图片模块)
        {
            this.读取2D图片模块 = 读取2D图片模块;
        }

        //public void set_3d(C_Cloud_Get 读取3D点云模块)
        //{
        //    this.读取3D点云模块 = 读取3D点云模块;
        //}


        public void 深度图处理2(
            Data_RGB pLast,
            C_Train pTrain,
            C_Camera_Const p1,
            uint16_t_ARRAY depth_pixel_arr,
            TY_VECT_3F_ARRAY p3dArray,
            TY_IMAGE_DATA img,
            int color_width, int color_height,
            int depth_width, int depth_height)
        {

            int n = color_width * color_height * 3;
            //uint8_t_ARRAY buff = new uint8_t_ARRAY((int)n);
            try
            {
                //SWIGTYPE_p_unsigned_char mappedRgb = buff.cast();

                space.console.WriteLine("读取点云数据！", Level_Enum.Info, this.log_index, this.Name);


                int u = img.width / 2;
                int v = img.height / 2;
                int offset = img.width * v + u;
                ushort d_tmp = depth_pixel_arr[offset];

                //if (this.Image_Point_3D == null)
                {
                    this.Image_Point_3D = new C_Point3D[this.camera_w, this.camera_h];
                }

                this.pList_Point3D_Color = new List<C_Point3D>();


                if (this.depth_camera=="1")// && space.vars.bUndistort == false)
                {
                    space.console.WriteLine("设置深度图片开始（没有对齐的深度图）", Level_Enum.Info, this.log_index, this.Name);
                    try
                    {
                        if (img.width > 0 && img.height > 0)
                        {

                            this.pBitmap_Depth = new Bitmap(img.width, img.height);
                        }
                        else
                        {
                            space.console.WriteLine("pic error img width=0 !", Level_Enum.Info, this.log_index, this.Name);
                        }
                    }
                    catch (Exception ex)
                    {
                        space.console.WriteLine(ex.ToString(), Level_Enum.Info, this.log_index, this.Name   );
                    }
                    space.console.WriteLine("设置深度图片结束", Level_Enum.Info, this.log_index, this.Name  );
                }
                space.console.WriteLine("图片抓取成功! ", Level_Enum.Info, this.log_index, this.Name  );

                {

                    if (depth_2_rgb)
                    {

                        space.console.WriteLine("将深度图对齐到彩色图坐标系 Start! ", Level_Enum.Info, this.log_index, this.Name);

                        //SDK.TYMapDepthImageToColorCoordinate(
                        //    p1.depth_calib,
                        //    (uint)depth_width, (uint)depth_height,
                        //    depth_pixel_arr.cast(), p1.color_calib,
                        //    (uint)color_width, (uint)color_height,
                        //    this.registration_depth_data.cast());

                    }
                    else
                    {
                        space.console.WriteLine("将彩色图对齐到深度图坐标系 Start! ", Level_Enum.Info, this.log_index, this.Name );
                        //SDK.TYMapRGBImageToDepthCoordinate(
                        //    p1.depth_calib,
                        //    (uint)depth_width, (uint)depth_height,
                        //    depth_pixel_arr.cast(), p1.color_calib,
                        //    (uint)color_width, (uint)color_height,
                        //    pLast.pixel_arr.cast(), //this.undistort_color_data.cast(),
                        //    mappedRgb);

                        //pTrain = MySaveBMP(pTrain, buff, this.key_save, img.width, img.height);
                        //this.读取2D图片模块.Run();
                        //space.console.WriteLine(" End! ");
                    }

                    space.console.WriteLine("深度图转3D点云图! ", Level_Enum.Info, this.log_index, this.Name);

                    if (depth_2_rgb)
                    {
                        //SDK.TYMapDepthImageToPoint3d(p1.color_calib, img.width, img.height, this.registration_depth_data.cast(), p3dArray.cast(), 1);
                        depth_result = registration_depth_data;
                    }
                    else
                    {
                        //SDK.TYMapDepthImageToPoint3d(p1.depth_calib, img.width, img.height, depth_pixel_arr.cast(), p3dArray.cast(), 1);
                        depth_result = depth_pixel_arr;
                    }

                    //if (this.glb_p3dArray != null)
                    //{
                    //    TY_VECT_3F_ARRAY.ReleasePtr(this.glb_p3dArray);
                    //}
                    this.glb_p3dArray = p3dArray;


                    space.save_vars(pTrain, this, this.key_3d, "TY_VECT_3F_ARRAY", p3dArray);

                    读取点云(img, pTrain);

                    if ((string)space.read_vars(pTrain, this, "#sys.read.depth", "string") == "1")
                    {
                        string file = (string)space.read_vars(pTrain, this, "#sys.depth.file", "string");
                        try
                        {
                            File.WriteAllText(file, "");
                            for (v = 0; v < img.height; v++)
                            {
                                string strLine = "";
                                for (u = 0; u < img.width; u++)
                                {
                                    int index = img.width * v + u;
                                    double d = (double)this.depth_result[index];
                                    if (d > 0)
                                    {
                                        strLine += d + ",";
                                    }
                                }
                                File.AppendAllText(file, strLine + "\r\n");
                            }
                        }
                        catch (Exception ex)
                        {
                            space.console.WriteLine(ex.ToString(), Level_Enum.Info, this.log_index, this.Name);
                        }
                        space.console.WriteLine("设置深度图片结束", Level_Enum.Info, this.log_index, this.Name);
                    }
                }

                if (this.save_color_cloud == "1")// space.vars.read_undistort_rgb)
                {
                    MySave_Point3D_Color(p3dArray, this.undistort_color_data, color_width, color_height);
                }
                this.bCatching = false;
                //
            }
            catch (Exception e)
            {
                MessageBox.Show(e.ToString());
                Console.WriteLine(e.ToString());
            }
            //finally
            //{
            //    uint8_t_ARRAY.ReleasePtr(buff);
            //}
        }

        public C_Train MySaveBMP(
            C_Train pTrain,
            uint8_t_ARRAY color_pixel_arr,
            string key_rgb,
            int width, int height)
        {

            Bitmap pBitmapRGB = ByteToBitmap(color_pixel_arr, width, height);

            Bitmap Bmp2 = new Bitmap(pBitmapRGB);
            //Bmp2.Save("D:/bmp_" + key_rgb + ".png");
            if (key_rgb != "")
            {
                space.save_vars(pTrain, this, key_rgb, "Bitmap", Tools.CopyBmp(Bmp2));
            }


            nCount_TuYang++;

            //if (file1 != "")
            //{
            //    Bitmap b2 = Tools.CopyBmp(Bmp2);
            //    Console.WriteLine("MySaveBMP.file1=" + file1);
            //}
            nCount_TuYang++;
            {
                //pTrain.pBitmapRGB_BAK2 = Tools.CopyBmp(Bmp2);
                space.save_vars(pTrain, this, this.key_compare, "Bitmap", Tools.CopyBmp(Bmp2));//pTrain.pBitmapRGB_Compare =
            }
            return pTrain;
        }


        public override Task run_sub()
        {
            run_sub_main();
            return Task.CompletedTask;
        }

        private void run_sub_main()
        {
            if (this.key_rgb != "")
            {
                this.key_save = this.key_rgb;
            }
            space.console.WriteLine("***开始拍照", Level_Enum.Info, this.log_index, this.Name   );
            TimeSpan pTimeNew = new TimeSpan(DateTime.Now.Ticks);

            if (old != null)
            {
                double Milliseconds = pTimeNew.Subtract(old).TotalMilliseconds;
                if (Milliseconds < 300)
                {
                    space.console.WriteLine("拍照速度太快！", Level_Enum.Info, this.log_index, this.Name);
                    return;
                }
            }
            old = pTimeNew;

            Pic_Index++;

            camera_hk.trigger();

            new Task(() =>
            {
                Console.Beep(3000, 200);
            }).Start();
        }


        //保存点云的颜色信息
        public void MySave_Point3D_Color(
            TY_VECT_3F_ARRAY p3dArray,
            uint8_t_ARRAY undistort_color_data,
            int width, int height)
        {
            space.console.WriteLine("MySave_Point3D_Color Start", Level_Enum.Info, this.log_index, this.Name);
            //int len = width * height * 3;

            //对每一个像素的颜色进行转化
            //C_Rect pRect = pspace.vars.box1.pRect1;
            //if (pRect != null)
            {
                for (int v = 0; v < height; v += 1) // C_Main.step_x)
                {
                    for (int u = 0; u < width; u += 1)// C_Main.step_y)
                    {
                        int offset = width * v + u;
                        int offset2 = offset * 3;

                        C_Point3D pPoint2 = this.Image_Point_3D[u, v];
                        if (pPoint2 != null)
                        {
                            pPoint2.x = p3dArray.getitem(offset).x;
                            pPoint2.y = p3dArray.getitem(offset).y;
                            pPoint2.z = p3dArray.getitem(offset).z;
                            this.pList_Point3D_Color.Add(pPoint2);

                            byte b = undistort_color_data[offset2];
                            byte g = undistort_color_data[offset2 + 1];
                            byte r = undistort_color_data[offset2 + 2];

                            pPoint2.pExtend = new C_Color(r, g, b);
                        }
                    }
                }
                space.save_vars(pTrain, this, "#color_cloud", "List<C_Point3D>", pList_Point3D_Color);
            }

            space.console.WriteLine("MySave_Point3D_Color End", Level_Enum.Info, this.log_index, this.Name);
        }


        public void Start_Camera(C_Camera_Const camera1)
        {

            S_TTS.speak_async("启动摄像头");
            if (this.wait == "")
            {
                S_TTS.speak_async("相机的wait没有设置");
                MessageBox.Show("相机的wait没有设置！");
                return;
            }
            Thread.Sleep(int.Parse(this.wait));

            //camear_init();

            uint8_t_ARRAY[] buffer = new uint8_t_ARRAY[2];

            DeviceInfoVector devs = new DeviceInfoVector();
            try
            {
                Main.WriteLine(this,"摄像头 ID=" + this.camera_id);
                string camera_id = space.tools.var_read(pTrain,this, this.camera_id);

                space.console.WriteLine("摄像头 ID=" + camera_id, Level_Enum.Info, this.log_index, this.Name);
                //SDK.selectDevice(SDK.TY_INTERFACE_ALL, camera_id, "", 10, devs);
                int sz = devs.Count();

                for (var i = 0; i < sz; i++)
                {
                    var item2 = devs[i];
                    space.console.WriteLine("摄像头 ID=" + item2.id, Level_Enum.Info, this.log_index, this.Name    );

                }

                if (devs.Count == 0)
                {
                    S_TTS.speak_async("没找到摄像头");
                    MessageBox.Show("没找到摄像头！");
                    return;
                }
                var item = devs[0];//选相机0
                var dev_info = item;

                dev_handle = new IntPtr();
                IntPtr iface_handle = new IntPtr();
                //打开接口
                //int a = SDK.TYOpenInterface(dev_info.iface.id, ref iface_handle);
                //space.console.WriteLine(a + "");
                //打开设备

                IntPtr errCode = IntPtr.Zero;
                //SDK.TYOpenDevice(iface_handle, dev_info.id, ref dev_handle, ref errCode);
                //SDK.TYOpenDevice(iface_handle, dev_info.id, ref dev_handle);
                //循环获取帧

                handle = dev_handle;

                Thread thread = new Thread(Loop_RGB_Process);
                thread.IsBackground = true;
                thread.Start();


                Loop_TuYang_Camera(dev_handle, camera1);


                ////停止采集
                //SDK.TYStopCapture(dev_handle);
                ////关闭设备与接口
                //SDK.TYCloseDevice(dev_handle, false);
                //SDK.TYCloseInterface(iface_handle);
            }
            catch (Exception ex)
            {
                Main.WriteLine(this, ex.ToString());
            }
        }


        public void Loop_RGB_Process()
        {
            while (space.vars.bClosingWindows == false)
            {
                if (RGB_Array.Count == 0)
                {
                    Thread.Sleep(10);
                    continue;
                }
                Data_RGB pData_RGB = null;
                lock (RGB_Array)
                {
                    if (RGB_Array.Count == 0) continue;
                    pData_RGB = (Data_RGB)RGB_Array[0];
                    RGB_Array.RemoveAt(0);
                }
                //RGB图处理(p1.pixel_arr, p1.img, p1.img.width, p1.img.height);

                //this.读取2D图片模块.pLast2 = pData_RGB;
                //this.读取2D图片模块.pixel_arr = pData_RGB.pixel_arr;
                //this.读取2D图片模块.img = pData_RGB.img;
                //this.读取2D图片模块.color_data = color_data;
                //this.读取2D图片模块.pCamera = this;
                //this.读取2D图片模块.pTrain = this.pTrain;
                //pData_RGB.pixel_arr = null;
                //pData_RGB.img = null;

                //if (depth_2_rgb)
                //{
                //    this.读取2D图片模块.Run();
                //}

            }
        }

        public void start()
        {
            Thread.Sleep(1000);
            {
                //const_flag.重启摄像头 = false;
                Task.Run(() =>
                {

                    C_Camera_Const camera1;
                    lock (space.vars)
                    {
                        camera1 = (C_Camera_Const)space.read_vars(pTrain, this, key_camera, "C_Camera_Const");
                        if (camera1 == null)
                        {
                            camera1 = new C_Camera_Const();
                            space.save_vars(pTrain, this, key_camera, "C_Camera_Const", camera1);
                        }
                        this.camera_const = camera1;
                    }

                    //Start_Camera(camera1);
                });
            }
        }



        private void Camera_Receive(Object obj, C_Camera_Const const1)
        {
            //// ParametersMain psm = (ParametersMain)obj;

            //TY_FRAME_DATA frame = new TY_FRAME_DATA();

            //while (recvFlag)
            //{
            //    Camera_Receive_Read = true;

            //    if (space.vars.bClosingWindows)
            //    {
            //        break;
            //    }

            //    if (Pic_Count == -1)
            //    {
            //        Thread.Sleep(10);
            //        continue;
            //    }

            //    if (pTrain == null)
            //    {
            //        Thread.Sleep(10);
            //        continue;
            //    }

            //    try
            //    {
            //        space.console.WriteLine("0-Camera_Receive Pic_Count=" + Pic_Count);

            //        int ret = SDK.TYFetchFrame(psm.mHandle, frame, 2000);

            //        if (ret < 0)
            //        {
            //            space.console.WriteLine("ret=" + ret);

            //            const_flag.重启摄像头 = true;
            //            continue;
            //        }

            //        Pic_Count++;
            //        space.console.WriteLine("1-Camera_Receive Pic_Count=" + Pic_Count);

            //        var images = frame.image;
            //        for (int idx = 0; idx < frame.validCount; idx++)
            //        {
            //            var img = images[idx];
            //            if (img.componentID == SDK.TY_COMPONENT_DEPTH_CAM)
            //            {
            //                if (Pic_Count != 2) continue;
            //                var pixel_arr_depth = uint16_t_ARRAY.FromVoidPtr(img.buffer, img.size / 2);

            //                int offset = img.width * img.height / 2 + img.width / 2;
            //                ushort distance = pixel_arr_depth[offset];

            //                space.vars.save_vars(pTrain, "#img_depth", "TY_IMAGE_DATA", img);

            //                Thread_Depth_Img pImg = new Thread_Depth_Img(pTrain, const1, this, Pic_Count, pixel_arr_depth, img);
            //                pImg.run();
            //                Pic_Count = -1;
                            
            //            }
            //            else if (img.componentID == SDK.TY_COMPONENT_RGB_CAM)
            //            {
            //                if (Pic_Count != 1) continue;
            //                var pixel_arr = uint8_t_ARRAY.FromVoidPtr(img.buffer, img.size);
            //                if (img.pixelFormat == SDK.TY_PIXEL_FORMAT_YVYU)
            //                {
            //                    //SDK_ISP.ConvertYVYU2RGB(pixel_arr, color_data, img.width, img.height);

            //                    //Console.WriteLine(string.Format("Color Image Center Pixel value(YVYU):{0} {1} {2}", r, g, b));
            //                }
            //                else if (img.pixelFormat == SDK.TY_PIXEL_FORMAT_YUYV)
            //                {
            //                    SDK_ISP.ConvertYUYV2RGB(pixel_arr, this.color_data, img.width, img.height);

            //                    //SWIGTYPE_p_void pointer = (SWIGTYPE_p_void)this.color_data.VoidPtr();
            //                    int offset = 3 * (img.width * img.height / 2 + img.width / 2);

            //                    //TY_IMAGE_DATA out_buff = SDK.TYInitImageData((uint)psm.color_size, pointer, (uint)(img.width), (uint)(img.height));
            //                    //out_buff.pixelFormat = (int)SDK.TY_PIXEL_FORMAT_BGR;

            //                    //SDK.TYISPProcessImage(psm.color_isp_handle, img, out_buff);
            //                    //SDK.TYISPUpdateDevice(psm.color_isp_handle);

            //                    ////var color_pixel_arr = uint8_t_ARRAY.FromVoidPtr(out_buff.buffer, img.size * 3);
            //                    //this.color_data2 = uint8_t_ARRAY.FromVoidPtr(out_buff.buffer, img.size * 3);
            //                    ////IntPtr ptr2 = this.color_data.VoidPtr2();

            //                    this.src.width = this.color_width;
            //                    this.src.height = this.color_height;
            //                    this.src.size = 3 * this.color_width * this.color_height;
            //                    this.src.pixelFormat = (int)SDK.TY_PIXEL_FORMAT_RGB;
            //                    this.src.buffer = this.color_data.VoidPtr();

            //                    //this.MySaveBMP(pTrain, color_data, "test1", img.width, img.height);//, "d:/test1.png");

            //                    this.dst.width = img.width;
            //                    this.dst.height = img.height;
            //                    this.dst.size = 3 * img.width * img.height;
            //                    this.dst.pixelFormat = (int)SDK.TY_PIXEL_FORMAT_RGB;
            //                    this.dst.buffer = undistort_color_data.VoidPtr();

            //                    C_Camera_Const camera1 = (C_Camera_Const)space.vars.read_vars(pTrain, this.key_camera, "C_Camera_Const");
            //                    if (camera1 == null)
            //                    {
            //                        MessageBox.Show(this.Name + " key_camera 设置有问题！");
            //                        return;
            //                    }
            //                    if (this.show_log == "1")
            //                        space.console.WriteLine("彩色图畸变矫正 Start! ");
            //                    SDK.TYUndistortImage(camera1.color_calib, this.src, null, this.dst);
            //                    if (this.show_log == "1")
            //                        space.console.WriteLine("彩色图畸变矫正 End! ");
            //                    //byte b2 = this.undistort_color_data[offset];
            //                    //byte g2 = this.undistort_color_data[offset + 1];
            //                    //byte r2 = this.undistort_color_data[offset + 2];
            //                    //this.MySaveBMP(pTrain, undistort_color_data, "test2", img.width, img.height, "d:/test2.png");


            //                    //if (Pic_Count == 1)
            //                    {
            //                        Data_RGB pData = new Data_RGB(Pic_Count, this.undistort_color_data, img);// this.color_data, img);
            //                        RGB_Array.Add(pData);
            //                    }
            //                    //Console.WriteLine(string.Format("Color Image Center Pixel value(YUYV):{0} {1} {2}", r, g, b));
            //                }
            //                else if (img.pixelFormat == SDK.TY_PIXEL_FORMAT_BAYER8GB)
            //                {
            //                    SWIGTYPE_p_void pointer = (SWIGTYPE_p_void)this.color_data.VoidPtr();
            //                    int offset = 3 * (img.width * img.height / 2 + img.width / 2);

            //                    TY_IMAGE_DATA out_buff = SDK.TYInitImageData((uint)psm.color_size, pointer, (uint)(img.width), (uint)(img.height));
            //                    out_buff.pixelFormat = (int)SDK.TY_PIXEL_FORMAT_BGR;

            //                    SDK.TYISPProcessImage(psm.color_isp_handle, img, out_buff);
            //                    SDK.TYISPUpdateDevice(psm.color_isp_handle);

            //                    //var color_pixel_arr = uint8_t_ARRAY.FromVoidPtr(out_buff.buffer, img.size * 3);
            //                    this.color_data2 = uint8_t_ARRAY.FromVoidPtr(out_buff.buffer, img.size * 3);
            //                    //IntPtr ptr2 = this.color_data.VoidPtr2();

            //                    this.src.width = this.color_width;
            //                    this.src.height = this.color_height;
            //                    this.src.size = 3 * this.color_width * this.color_height;
            //                    this.src.pixelFormat = (int)SDK.TY_PIXEL_FORMAT_RGB;
            //                    this.src.buffer = this.color_data2.VoidPtr();

            //                    //this.MySaveBMP(pTrain, color_data2, "test1", img.width, img.height, "d:/test1.png");

            //                    this.dst.width = img.width;
            //                    this.dst.height = img.height;
            //                    this.dst.size = 3 * img.width * img.height;
            //                    this.dst.pixelFormat = (int)SDK.TY_PIXEL_FORMAT_RGB;
            //                    this.dst.buffer = undistort_color_data.VoidPtr();

            //                    C_Camera_Const camera1 = (C_Camera_Const)space.vars.read_vars(pTrain, this.key_camera, "C_Camera_Const");
            //                    if (camera1 == null)
            //                    {
            //                        MessageBox.Show(this.Name + " key_camera 设置有问题！");
            //                        return;
            //                    }
            //                    if (this.show_log == "1")
            //                        space.console.WriteLine("彩色图畸变矫正 Start! ");
            //                    SDK.TYUndistortImage(camera1.color_calib, this.src, null, this.dst);

            //                    uint8_t_ARRAY.ReleasePtr(this.color_data2);

            //                    if (this.show_log == "1")
            //                        space.console.WriteLine("彩色图畸变矫正 End! ");
            //                    //byte b2 = this.undistort_color_data[offset];
            //                    //byte g2 = this.undistort_color_data[offset + 1];
            //                    //byte r2 = this.undistort_color_data[offset + 2];
            //                    //this.MySaveBMP(pTrain, undistort_color_data, "test2", img.width, img.height, "d:/test2.png");

            //                    //if (Pic_Count == 1)
            //                    {
            //                        Data_RGB p1 = new Data_RGB(Pic_Count, undistort_color_data, img);
            //                        RGB_Array.Add(p1);
            //                    }
            //                }
            //                else
            //                {
                                
            //                    Console.WriteLine(string.Format("Color Image Type:{0}", img.pixelFormat));
            //                }
            //                uint8_t_ARRAY.ReleasePtr(pixel_arr);//这里去掉会泄露
            //            }
            //        }

            //        SDK.TYEnqueueBuffer(psm.mHandle, frame.userBuffer, (uint)frame.bufferSize);
            //        //img_index++;
            //    }
            //    catch (System.ComponentModel.Win32Exception ex)
            //    {
            //        Console.WriteLine(ex.ToString());
            //    }
            //}

            //Camera_Receive_Read = false;
        }


        public void Loop_TuYang_Camera(IntPtr handle, C_Camera_Const camera1)
        {


        //    IntPtr color_isp_handle = new IntPtr();

        //    uint cal_size = camera1.depth_calib.CSize();

        //    Console.WriteLine(this.Name);
        //    //获取深度相机标定参数
        //    uint cal_size1 = camera1.depth_calib.CSize();
        //    SDK.TYGetStruct(handle, SDK.TY_COMPONENT_DEPTH_CAM, SDK.TY_STRUCT_CAM_CALIB_DATA, camera1.depth_calib.getCPtr(), cal_size1);
        //    //this.get_depth_calib = true;

        //    //获取彩色相机标定参数																																																																			  																									  																								  
        //    uint cal_size2 = camera1.color_calib.CSize();
        //    SDK.TYGetStruct(handle, SDK.TY_COMPONENT_RGB_CAM, SDK.TY_STRUCT_CAM_CALIB_DATA, camera1.color_calib.getCPtr(), cal_size2);


        //    SDK.TYGetStruct(handle, SDK.TY_COMPONENT_DEPTH_CAM, SDK.TY_STRUCT_CAM_CALIB_DATA, camera1.depth_calib.getCPtr(), cal_size);

        //    if (this.show_log == "1")
        //        Console.WriteLine(string.Format("Depth calib inf width:{0} height:{1}", camera1.depth_calib.intrinsicWidth, camera1.depth_calib.intrinsicHeight));
        //    if (this.show_log == "1")
        //        Console.WriteLine(string.Format("深度相机内参:{0} {1} {2} {3} {4} {5} {6} {7} {8}",
        //        camera1.depth_calib.intrinsic.data[0], camera1.depth_calib.intrinsic.data[1], camera1.depth_calib.intrinsic.data[2],
        //        camera1.depth_calib.intrinsic.data[3], camera1.depth_calib.intrinsic.data[4], camera1.depth_calib.intrinsic.data[5],
        //        camera1.depth_calib.intrinsic.data[6], camera1.depth_calib.intrinsic.data[7], camera1.depth_calib.intrinsic.data[8]));


        //    SDK.TYEnableComponents(handle, SDK.TY_COMPONENT_DEPTH_CAM);
        //    SDK.TYEnableComponents(handle, SDK.TY_COMPONENT_RGB_CAM);
        //    //set depth cam resolution
        //    int status = SDK.TYSetEnum(handle, SDK.TY_COMPONENT_DEPTH_CAM, SDK.TY_ENUM_IMAGE_MODE, (int)(SDK.TY_RESOLUTION_MODE_1280x960 | SDK.TY_PIXEL_FORMAT_DEPTH16));
        //    //set color cam resolution
        //    //SDK.TYSetEnum(handle, SDK.TY_COMPONENT_RGB_CAM, SDK.TY_ENUM_IMAGE_MODE, (int)(SDK.TY_RESOLUTION_MODE_1280x960 | SDK.TY_PIXEL_FORMAT_BAYER8GB));

        //    if (this.camera_format == "yuyv")
        //    {
        //        status = SDK.TYSetEnum(handle, SDK.TY_COMPONENT_RGB_CAM, SDK.TY_ENUM_IMAGE_MODE, (int)(SDK.TY_RESOLUTION_MODE_1280x960 | SDK.TY_PIXEL_FORMAT_YUYV));

        //    }
        //    else
        //    {
        //        status = SDK.TYSetEnum(handle, SDK.TY_COMPONENT_RGB_CAM, SDK.TY_ENUM_IMAGE_MODE, (int)(SDK.TY_RESOLUTION_MODE_1280x960 | SDK.TY_PIXEL_FORMAT_BAYER8GB));

        //    }


        //    SDK.TYISPCreate(ref color_isp_handle);
        //    SDK_ISP.ColorIspInitSetting(color_isp_handle, handle);

        //    uint buff_sz;
        //    SDK.TYGetFrameBufferSize(handle, out buff_sz);


        //    //获取彩色图宽和高
        //    //int color_width, color_height;
        //    SDK.TYGetInt(handle, SDK.TY_COMPONENT_RGB_CAM, SDK.TY_INT_WIDTH, out this.color_width);
        //    SDK.TYGetInt(handle, SDK.TY_COMPONENT_RGB_CAM, SDK.TY_INT_HEIGHT, out this.color_height);

        //    if (this.show_log == "1")
        //        space.console.WriteLine(string.Format("RGB 图像 大小:{0} {1}", this.color_width, this.color_height));
        //    S_TTS.speak_async("摄像头初始化完毕");

        //    int color_size = this.color_width * this.color_height * 3;
        //    this.color_data = new uint8_t_ARRAY(color_size);
        //    this.undistort_color_data = new uint8_t_ARRAY(color_size);
        //    this.registration_depth_data = new uint16_t_ARRAY(color_size);



        //    buffer[0] = new uint8_t_ARRAY((int)buff_sz);
        //    buffer[1] = new uint8_t_ARRAY((int)buff_sz);
        //    buffer[2] = new uint8_t_ARRAY((int)buff_sz);
        //    buffer[3] = new uint8_t_ARRAY((int)buff_sz);

        //    //this.color_data = new uint8_t_ARRAY(color_size);
        //    SDK.TYEnqueueBuffer(handle, buffer[0].VoidPtr(), buff_sz);
        //    SDK.TYEnqueueBuffer(handle, buffer[1].VoidPtr(), buff_sz);
        //    SDK.TYEnqueueBuffer(handle, buffer[2].VoidPtr(), buff_sz);
        //    SDK.TYEnqueueBuffer(handle, buffer[3].VoidPtr(), buff_sz);

        //    //设置触发
        //    TY_TRIGGER_PARAM param = new TY_TRIGGER_PARAM();
        //    //param.mode = SDK.TY_TRIGGER_MODE_OFF;//关闭触发，自由采集模式
        //    param.mode = SDK.TY_TRIGGER_MODE_SLAVE;//开启触发，支持软硬触发

        //    bool hasResend;
        //    SDK.TYHasFeature(handle, SDK.TY_COMPONENT_DEVICE, SDK.TY_BOOL_GVSP_RESEND, out hasResend);
        //    if (hasResend)
        //    {
        //        if (this.show_log == "1")
        //            space.console.WriteLine("设置网络模式：有错误就重发");
        //        SDK.TYSetBool(handle, SDK.TY_COMPONENT_DEVICE, SDK.TY_BOOL_GVSP_RESEND, true);
        //    }

        //    //异步抓取
        //    SDK.TYSetEnum(handle, SDK.TY_COMPONENT_DEVICE, SDK.TY_ENUM_STREAM_ASYNC, (int)(SDK.TY_STREAM_ASYNC_RGB));

        //    SDK.TYSetStruct(handle, SDK.TY_COMPONENT_DEVICE, SDK.TY_STRUCT_TRIGGER_PARAM, param.getCPtr(), param.CSize());

        //    SDK.TYStartCapture(handle);

        //    recvFlag = true;

        //    Task.Run(() =>
        //    {
        //        ParametersMain psm = new ParametersMain(handle, color_size, color_isp_handle);
        //        Camera_Receive(psm, camera1);
        //    });

        //    while (space.vars.bClosingWindows == false)
        //    {
        //        if (Camera_Receive_Read == false) continue;

        //        if (const_flag.重启摄像头)
        //        {
        //            this.pLoop_Camera = null;
        //            break;
        //        }
        //        if (space.vars.bAutoMode == false)
        //        {
        //            Thread.Sleep(10);
        //            continue;
        //        }
        //        if (this.bCatching == false)
        //        {
        //            Thread.Sleep(10);
        //            continue;
        //        }
        //        else
        //        {
        //            if (this.show_log == "1")
        //                space.console.WriteLine("TY软激活" + this.Name);

        //            DateTime robot_time_f = new DateTime(DateTime.Now.Ticks);
        //            space.vars.save_vars(pTrain, this.key_camera_time, "DateTime", robot_time_f);

        //            SDK.TYSendSoftTrigger(handle);
        //            Pic_Count = 0;

        //            this.bCatching = false;
        //        }
        //        Thread.Sleep(100);
        //    }

        //ExitProcess:
        //    recvFlag = false;
        //    Thread.Sleep(100);
        }





        public static Bitmap ByteToBitmap(uint8_t_ARRAY color_pixel_arr, int width, int height)// byte[] imgBGR)
        {
            //space.console.WriteLine("ByteToBitmap Start",true);
            int len = width * height * 3;
            //构造一个位图数组进行数据存储
            byte[] rgbvalues = new byte[len];

            //space.console.WriteLine("开始内存复制图片1", true);
            {
                IntPtr ptr2 = color_pixel_arr.VoidPtr2();

                Marshal.Copy(ptr2, rgbvalues, 0, len);
            }
            //space.console.WriteLine("开始内存复制图片2", true);

            //位图矩形

            Bitmap bmp = new Bitmap(width, height, PixelFormat.Format24bppRgb);

            Rectangle rect = new Rectangle(0, 0, bmp.Width, bmp.Height);
            //以可读写的方式将图像数据锁定
            BitmapData bmpdata = bmp.LockBits(rect, ImageLockMode.ReadWrite, bmp.PixelFormat);
            //得到图形在内存中的首地址
            IntPtr ptr = bmpdata.Scan0;

            //把处理后的图像数组复制回图像
            Marshal.Copy(rgbvalues, 0, ptr, len);
            //解锁位图像素
            bmp.UnlockBits(bmpdata);

            //space.console.WriteLine("ByteToBitmap End", true);
            return bmp;
        }


        public void 读取点云(
            TY_IMAGE_DATA img,
            C_Train pTrain)
        {
            //this.读取3D点云模块.img = img;
            //this.读取3D点云模块.glb_p3dArray = glb_p3dArray;
            //this.读取3D点云模块.Image_Point_3D = Image_Point_3D;


            //this.读取3D点云模块.registration_depth_data = this.registration_depth_data;
            ////this.读取3D点云模块.pTrain = this.pTrain;
            //this.读取3D点云模块.Run(pTrain);
        }

    }
}
