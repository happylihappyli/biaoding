using Common_Robot2;
using dll_ssh;
using Newtonsoft.Json.Linq;

namespace Test1
{
    public class W_SSH_Command : C_Node
    {
        public string step_ssh = "0";
        public string str_commands = "";
        public string long_command = "0";
        public c_ssh ssh = null;

        public W_SSH_Command(string name, C_Space space_parent, C_Space space) :
            base(name, space_parent, space)
        {
        }


        public override Task run_sub()
        {
            run_sub_main();
            return Task.CompletedTask;
        }
        public override void init()
        {
            W_SSH step = (W_SSH)space.vars_step[step_ssh];
            if (step.p_ssh != null)
            {
                this.ssh = step.p_ssh;
                //this.ssh.Event_SendMsg += Ssh_Event_SendMsg;
            }

        }
        private void run_sub_main()
        {
            string strCommands = space.tools.var_read(pTrain, this, this.str_commands);
            JArray pArray = JArray.Parse(strCommands);
            for (var i = 0; i < pArray.Count; i++)
            {
                JObject item = (JObject)pArray[i];

                if (item.ContainsKey("expect"))
                {
                    string cmd = item.GetValue("cmd").ToString();

                    string cmd_new = space.tools.var_read(pTrain, this, cmd);

                    string expect = item.GetValue("expect").ToString();
                    string expect_new = space.tools.var_read(pTrain, this, expect);

                    string wait = item.GetValue("wait").ToString();
                    string wait_new = space.tools.var_read(pTrain, this, wait);

                    ssh.stream_expect("",
                        expect_new,
                        cmd_new,
                        int.Parse(wait_new));
                }
                else
                {
                    string cmd = item.GetValue("cmd").ToString();
                    if (cmd == "@cmd2")
                    {
                        Console.WriteLine("error");
                    }
                    string cmd_new = space.tools.var_read(pTrain, this, cmd);

                    ssh.stream_command("cmd", cmd_new);
                }
            }

            if (long_command == "0")
            {
                ssh.stream_result(2);
            }
            else
            {
                //否则是长命令，要运行很长时间
            }
        }

    }

    
}
