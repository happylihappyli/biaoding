using Common_Robot2;
using ConverxHull;
using Downloader;

namespace Test1
{
    public class E_Download_Event : C_Node
    {
        public string key_step = "";
        public string key_msg = "";

        public E_Download_Event(string Name, C_Space space_parent, C_Space space) : base(space_parent, space)
        {
            this.Name = Name;
            space.vars_step.Add(Name, this);
        }


        public void init()
        {

            W_Download_Service pItem = (W_Download_Service)space.vars.vars_step[key_step];


            if (pItem != null)
            {
                pItem.pEvent += OnDownloadProgressChanged;
            }
        }

        double time_old_ticks = 0;
        private void OnDownloadProgressChanged(string msg)
        {
            Main.WriteLine(this, "进度=" + msg);

            Random rnd = new Random();
            int train_id = rnd.Next(100, 900);
            pTrain = CommonMain.create_train("download_" + train_id);

            int percent = (int)double.Parse(msg);
            this.save_var(this.key_msg, "string", percent+"");


            long time_new_ticks=DateTime.Now.Ticks;


            if (percent == 100)
            {
                Task.Run(() =>
                {
                    Run(pTrain);
                });
            }
            else if (time_new_ticks - time_old_ticks > 1000*10000) //10000就是1毫秒
            {
                time_old_ticks = time_new_ticks;
                
                Task.Run(() =>
                {
                    Run(pTrain);
                });
            }
            

        }



        public override Task run_sub()
        {
            return Task.CompletedTask;
        }

    }
}
