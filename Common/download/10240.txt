
using Common_Robot2;
using System.Drawing.Imaging;
using System.Runtime.InteropServices;

namespace Test1
{
    public class Img_Rotate : C_Node
    {
        public string? key_read;
        public string? angle;
        public string? key_save;
        public string? width;
        public string? height;

        public Img_Rotate(string name, C_Space space_parent, C_Space space) :
            base(name,space_parent, space)
        {
            this.Name = name;
            //space.vars_step.Add(name, this);
        }

        public override void init()
        {
            
        }

        public Bitmap RotateImage(Bitmap bmp1, double degrees,int newWidth,int newHeight)
        {

            Bitmap? bmp3 = new Bitmap(bmp1);// Tools.CopyBmp(bmp1);
            var angle = degrees * Math.PI / 180.0;
            var cos = Math.Cos(angle);
            var sin = Math.Sin(angle);
            var width = bmp3.Width;
            var height = bmp3.Height;
            var xOffset = width / 2;
            var yOffset = height / 2;

            
            var data1 = bmp3.LockBits(new Rectangle(0, 0, width, height), ImageLockMode.ReadOnly,
                PixelFormat.Format24bppRgb);// copy image to byte array

            Bitmap? bmp2 = new Bitmap(newWidth, newHeight);// create new bitmap
            var data2 = bmp2.LockBits(new Rectangle(0, 0, newWidth, newHeight),
                ImageLockMode.WriteOnly,
                PixelFormat.Format24bppRgb);


            var stride1 = data1.Stride;
            var stride2 = data2.Stride;

            byte[] buffer1 = new byte[data1.Stride * data1.Height];

            byte[] buffer2 = new byte[data2.Stride * data2.Height];
            Marshal.Copy(data1.Scan0, buffer1, 0, buffer1.Length);
            bmp3.UnlockBits(data1);

            // create buffer for image with back background
            //var resultBuffer = new byte[buffer2.Length];
            //for (int i = 0; i < resultBuffer.Length; ++i)
            //{
            //    resultBuffer[i] = 255;
            //}
            for (int i = 0; i < buffer2.Length; ++i)
            {
                buffer2[i] = 255;
            }

            // process rotation
            for (int row = 0; row < height; ++row)
            {
                for (int col = 0; col < width; ++col)
                {
                    var index = row * stride1 + col * 3;
                    var x = (int)Math.Round((col - xOffset) * cos - (row - yOffset) * sin) + newWidth/2;
                    var y = (int)Math.Round((col - xOffset) * sin + (row - yOffset) * cos) + newHeight/2;
                    var newIndex = y * stride2 + x * 3;

                    if (y >= 0 && y < newHeight && x >= 0 && x < newWidth)
                    {
                        if (newIndex + 5 < buffer2.Length)
                        {
                            buffer2[newIndex + 3] = buffer2[newIndex] = buffer1[index];
                            buffer2[newIndex + 4] = buffer2[newIndex + 1] = buffer1[index + 1];
                            buffer2[newIndex + 5] = buffer2[newIndex + 2] = buffer1[index + 2];
                        }
                        else
                        {
                            buffer2[newIndex] = buffer1[index];
                            buffer2[newIndex + 1] = buffer1[index + 1];
                            buffer2[newIndex + 2] = buffer1[index + 2];
                        }
                    }
                }
            }

            Marshal.Copy(buffer2, 0, data2.Scan0, buffer2.Length);
            bmp2.UnlockBits(data2);
            return bmp2;
        }



        public override Task run_sub()
        {
            run_sub_main();
            return Task.CompletedTask;
        }

        public void run_sub_main()
        {
            Bitmap? bmp =(Bitmap?)this.read_var(this.key_read, "Bitmap");
            if (bmp == null)
            {
                MessageBox.Show(this.Name + " 读取图片为空！");
                return;
            }
            string? angle2 = this.read_string(this.angle);
            float f_angle = float.Parse(angle2);
            try
            {
                if (width==null || height==null || int.Parse(width) * int.Parse(height) == 0)
                {
                    MessageBox.Show(this.Name+ "宽度，高度不能为0");
                    return;
                }
                lock (bmp) { 
                    Image img = RotateImage(bmp, f_angle, int.Parse(width), int.Parse(height));
                    Bitmap bmp2 = new Bitmap(img);
                    this.save_var(this.key_save, "Bitmap", bmp2);
                }
            }
            catch (Exception e)
            {
                Main.WriteLine(this,e.ToString());
            }

        }

    }
}
