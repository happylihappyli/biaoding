using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.IO;

//--------这里添加命名空间---------
using Test1.Common.Data;
using Common_Robot;
using static Common_Robot.C_Mp3;

namespace Test1
{
    public partial class Form1 : Form
    {
        C_Space space = new C_Space();
        C_Space space2 = new C_Space();
        C_Space space3 = new C_Space();

        public Form1()
        {
            InitializeComponent();
        }
        public void clear_module()
        {
        }

		
		//===模块===


        public void load_init(C_Space space_parent,C_Space space,string space_name){
				//===初始化===

                {
                    S_PictureBox_Show pState1 = (S_PictureBox_Show)space.vars.vars_step["图片显示"];
        pState1.picture_box = pBoxView;

                    S_PictureBox_Show pState2 = (S_PictureBox_Show)space.vars.vars_step["图片显示2"];
                    pState2.picture_box = pBoxView;

                    MessageBox.Show("loading finished");
                }

				space.vars.bClosingWindows = false;
				space.vars.bAutoMode = true;
				Task.Run(() => {
					space.检查步骤状态();
				});
        }
		
		public void set_input(C_Space space, string name, string from,bool true_false=true)
		{
			var p1 = space.vars.vars_step[name];
			var p2 = space.vars.vars_step[from];
			p1.init_input(p2, true_false);
        }
        
        private void pBoxStart_Click(object sender, EventArgs e)
        {
			C_State pState = (C_State)space3.vars.vars_step["点击拍照按钮"];
			pState.Run();
		}

        private void pBoxStop_Click(object sender, EventArgs e)
        {

			C_State pState = (C_State)space3.vars.vars_step["点击暂停"];
			pState.Run();
		}

        private void Form1_Load(object sender, EventArgs e)
        {
            //====================gaojundz@qq.com==================
            pBoxSet.Parent = pBoxBack;
            pBoxStart.Parent = pBoxBack;
            pBoxStop.Parent = pBoxBack;
            asc.controllInitializeSize(this);

            RectpBoxBack = new Rectangle(0, 0, 1146, 613);
            RectpBoxSet = new Rectangle(786, 5, 100, 50);
            RectpBoxStart = new Rectangle(905, 5, 100, 50);
            RectpBoxStop = new Rectangle(1024, 5, 100, 50);
            //=====================================================
            EncodingProvider provider = CodePagesEncodingProvider.Instance;
            Encoding.RegisterProvider(provider);

            string name = Environment.MachineName;
            string strFile = Application.StartupPath + "\\set_" + name + ".ini";
            if (File.Exists(strFile) == false)
			{
				string file1 = Application.StartupPath + "\\set.ini";
				if (File.Exists(file1))
					File.Copy(file1, strFile);
            }

            IniFile myIni = new IniFile(strFile);
            string serial = myIni.ReadString("main", "serial", "");

            C_Space_Load.form1 = this;

            m1.Path_Main = Application.StartupPath;
            
			space.console.pLog = (ILog)Logger.GetInstance(space);
            space2.console.pLog = (ILog)Logger.GetInstance(space2);
            space3.console.pLog = (ILog)Logger.GetInstance(space3);

            space.vars.save_vars(null, "#serial", "string", serial);
            space2.vars.save_vars(null, "#serial", "string", serial);


			Task.Run(() =>
			{
				space2.vars.copy_from(space);
				try
				{
					env(space, space2, "env","");
				}
				catch (Exception ex)
				{
					MessageBox.Show(ex.ToString());
					Console.WriteLine(ex.ToString());
				}
				
				int iCount = 0;
                while (space2.bExit_Loop==false)
                {
					iCount++;
					if (iCount >50)
                    {
						break;
					}
					Thread.Sleep(100);
				}
				space2.vars.bClosingWindows = true;
				space.vars.copy_from(space2);


				try
				{
					space3.vars.save_vars(null, "#serial", "string",serial);
					space3.vars.copy_from(space);
					load_init(space, space3, "main");
				}
				catch (Exception ex)
				{
					MessageBox.Show(ex.ToString());
					Console.WriteLine(ex.ToString());
				}

				
				Action act = delegate ()
				{
					//this.Controls.Remove(pLabel);
					this.CenterToScreen();
				};
				if (this != null)
					this.BeginInvoke(act, null);

               });


            //===调试窗口===
        }

        
        private void Form1_FormClosing(object sender, FormClosingEventArgs e)
        {
            space.vars.bClosingWindows = true;
            space2.vars.bClosingWindows = true;
            space3.vars.bClosingWindows = true;
			//===unload===
		}

        //=====================gaojundz@qq.com==========================
        #region 自适应类
        AutoSizeFormClass asc = new AutoSizeFormClass();
        class AutoSizeFormClass
        {
            //(1).声明结构,只记录窗体和其控件的初始位置和大小。  
            public struct controlRect
            {
                public int Left;
                public int Top;
                public int Width;
                public int Height;
            }
            //(2).声明 1个对象  
            //注意这里不能使用控件列表记录 List<Control> nCtrl;，因为控件的关联性，记录的始终是当前的大小。  
            public List<controlRect> oldCtrl;
            int ctrl_first = 0;
            //(3). 创建两个函数  
            //(3.1)记录窗体和其控件的初始位置和大小,  
            public void controllInitializeSize(Form mForm)
            {
                if (ctrl_first == 0)
                {
                    ctrl_first = 1;
                    oldCtrl = new List<controlRect>();
                    controlRect cR;
                    cR.Left = mForm.Left; cR.Top = mForm.Top; cR.Width = mForm.Width; cR.Height = mForm.Height;
                    oldCtrl.Add(cR);
                    foreach (Control c in mForm.Controls)
                    {
                        controlRect objCtrl;
                        objCtrl.Left = c.Left; objCtrl.Top = c.Top; objCtrl.Width = c.Width; objCtrl.Height = c.Height;
                        oldCtrl.Add(objCtrl);
                    }
                }
                //mForm.WindowState = (System.Windows.Forms.FormWindowState)(2);//记录完控件的初始位置和大小后，再最大化  
                //0 - Normalize , 1 - Minimize,2- Maximize  
            }
            //(3.2)控件自适应大小,  
            public void controlAutoSize(Form mForm, int WinY)
            {
                //int wLeft0 = oldCtrl[0].Left; ;//窗体最初的位置  
                //int wTop0 = oldCtrl[0].Top;  
                ////int wLeft1 = this.Left;//窗体当前的位置  
                //int wTop1 = this.Top;  
                float wScale = (float)mForm.Width / (float)oldCtrl[0].Width;//新旧窗体之间的比例，与最早的旧窗体  
                float hScale = (float)(mForm.Height + WinY) / (float)oldCtrl[0].Height;//.Height;  
                int ctrLeft0, ctrTop0, ctrWidth0, ctrHeight0;
                int ctrlNo = 1;//第1个是窗体自身的 Left,Top,Width,Height，所以窗体控件从ctrlNo=1开始  
                foreach (Control c in mForm.Controls)
                {
                    ctrLeft0 = oldCtrl[ctrlNo].Left;
                    ctrTop0 = oldCtrl[ctrlNo].Top;
                    ctrWidth0 = oldCtrl[ctrlNo].Width;
                    ctrHeight0 = oldCtrl[ctrlNo].Height;
                    //c.Left = (int)((ctrLeft0 - wLeft0) * wScale) + wLeft1;//新旧控件之间的线性比例  
                    //c.Top = (int)((ctrTop0 - wTop0) * h) + wTop1;  
                    c.Left = (int)((ctrLeft0) * wScale);//新旧控件之间的线性比例。控件位置只相对于窗体，所以不能加 + wLeft1  
                    c.Top = (int)((ctrTop0) * hScale);//  
                    c.Width = (int)(ctrWidth0 * wScale);//只与最初的大小相关，所以不能与现在的宽度相乘 (int)(c.Width * w);  
                    c.Height = (int)(ctrHeight0 * hScale);//  
                    ctrlNo += 1;
                }
            }

        }
        #endregion

        Rectangle RectpBoxBack;
        Rectangle RectpBoxSet;
        Rectangle RectpBoxStart;
        Rectangle RectpBoxStop;
        private void Form1_SizeChanged(object sender, EventArgs e)
        {
            try
            {
                asc.controlAutoSize(this, 0);
                pBoxStop.Width = RectpBoxStop.Width * pBoxBack.Width / RectpBoxBack.Width; pBoxStop.Height = RectpBoxStop.Height * pBoxBack.Height / RectpBoxBack.Height;
                pBoxStart.Width = RectpBoxStart.Width * pBoxBack.Width / RectpBoxBack.Width; pBoxStart.Height = RectpBoxStart.Height * pBoxBack.Height / RectpBoxBack.Height;
                pBoxSet.Width = RectpBoxSet.Width * pBoxBack.Width / RectpBoxBack.Width; pBoxSet.Height = RectpBoxSet.Height * pBoxBack.Height / RectpBoxBack.Height;
            }
            catch// (Exception ex)
            {
                //MessageBox.Show("asc.controlAutoSize异常：" + ex.ToString());
            }

            pBoxStop.Location = new Point(pBoxBack.Width - pBoxStop.Width, RectpBoxStop.Y);
            pBoxStart.Location = new Point(pBoxBack.Width - pBoxStart.Width - pBoxStop.Width, RectpBoxStart.Y);
            pBoxSet.Location = new Point(pBoxBack.Width - pBoxStart.Width - pBoxStop.Width - pBoxSet.Width, RectpBoxSet.Y);
        }
        //==============================================================
    }
}
